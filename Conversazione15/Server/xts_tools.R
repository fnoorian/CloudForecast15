library("RJSONIO")
library("xts")

#' Create xts from list
#' 
#' @param dt   A vector of data with timestamp as names, or
#'             a list of such vectors to denote multi-variate time-series
#' 
#' @return An xts object
vec.to.xts <- function(dt) {

  if ("list" %in% class(dt)) {
    # multi-series mode
    dt = do.call(cbind, dt)
    time_ind = strptime(rownames(dt), format = "%Y-%m-%dT%H:%M:%OSZ")
  } else {
    # single-series mode
    time_ind = strptime(names(dt), format = "%Y-%m-%dT%H:%M:%OSZ")  
  }

  return (xts(as.numeric(dt), time_ind))
}

#' Create a vector from xts object
#' 
#' @param xts.obj   The xts data
#' 
#' @return A vector of data with timestamp as names, or
#'             a list of such vectors to denote multi-variate time-series
xts.to.vec <- function(xts.obj) {
  time_ind = strftime(index(xts.obj), format = "%Y-%m-%dT%H:%M:%OSZ", tz="UTC")
  
  if (is.null(colnames(xts.obj))) {
    # single-series mode
    dt = as.numeric(xts.obj)
    names(dt) = time_ind
  } else {
    # data-frame mode
    
    dt = list()
    for (i in 1:ncol(xts.obj)) {
      # add each column as a separate list
      dt_col = as.numeric(xts.obj[,i])
      names(dt_col) = time_ind
      
      dt_name = colnames(xts.obj)[i]
      dt[[dt_name]] = dt_col
    }
  }
  
  return (dt)
}


#' Create xts from JSON
#' 
#' @param json   The JSON string
#' 
#' @return An xts object
json.to.xts <- function(json) {
  dt = RJSONIO::fromJSON(json)
  
  return (vec.to.xts(dt))
}

#' Create JSON from xts object
#' 
#' @param xts.obj   The xts data
#' 
#' @return A JSON string
xts.to.json <- function(xts.obj) {
 
  return (RJSONIO::toJSON(xts.to.vec(xts.obj)))
}

#' Convert CSV text data to an xts
#' 
#' @param text CSV text data
#' 
#' @retur An xts object
csv.text.to.xts <- function(text) {
  # convert text to data frame
  csv = read.csv(textConnection(text), stringsAsFactors=FALSE, strip.white=TRUE)
  
  csv.timestamps = csv[,1]
  csv.data = csv[,-1]
  
  original.timestamps = as.timeDate(csv.timestamps)
  time.series = xts(csv.data, original.timestamps)
  
  colnames(time.series) = colnames(csv)[-1]
  
  return (time.series)
}

#' Create csv style text from xts object
#' 
#' @param xts.obj   The xts data
#' 
#' @return A character string formatted in CSV style
xts.to.csv.text <- function(xts.obj) {
 
  # convert results to CSV
  textconn =  textConnection("csv.string", "w")
  write.csv(as.data.frame(xts.obj), file=textconn, row.names = TRUE)
  close(textconn)
  
  ret = NULL
  for (string in csv.string)
    ret = paste(ret, string, sep="\n")    
  
  return(ret)
}

.examples <- function() {
  v = '{"1991-07-01T00:00:00.000Z":3.526591,"1991-08-01T00:00:00.000Z":3.180891,"1991-09-01T00:00:00.000Z":3.252221,"1991-10-01T00:00:00.000Z":3.611003,"1991-11-01T00:00:00.000Z":3.565869,"1991-12-01T00:00:00.000Z":4.306371,"1992-01-01T00:00:00.000Z":5.088335,"1992-02-01T00:00:00.000Z":2.81452,"1992-03-01T00:00:00.000Z":2.985811,"1992-04-01T00:00:00.000Z":3.20478,"1992-05-01T00:00:00.000Z":3.127578,"1992-06-01T00:00:00.000Z":3.270523,"1992-07-01T00:00:00.000Z":3.73785082,"1992-08-01T00:00:00.000Z":3.55877609,"1992-09-01T00:00:00.000Z":3.77720173,"1992-10-01T00:00:00.000Z":3.92449042,"1992-11-01T00:00:00.000Z":4.38653092,"1992-12-01T00:00:00.000Z":5.81054917,"1993-01-01T00:00:00.000Z":6.19206769,"1993-02-01T00:00:00.000Z":3.45085699,"1993-03-01T00:00:00.000Z":3.77230686,"1993-04-01T00:00:00.000Z":3.7343029,"1993-05-01T00:00:00.000Z":3.90539892,"1993-06-01T00:00:00.000Z":4.04968714,"1993-07-01T00:00:00.000Z":4.31556552,"1993-08-01T00:00:00.000Z":4.56218455,"1993-09-01T00:00:00.000Z":4.60866203,"1993-10-01T00:00:00.000Z":4.66785129,"1993-11-01T00:00:00.000Z":5.09384145,"1993-12-01T00:00:00.000Z":7.1799622,"1994-01-01T00:00:00.000Z":6.73147308,"1994-02-01T00:00:00.000Z":3.84127758,"1994-03-01T00:00:00.000Z":4.39407557,"1994-04-01T00:00:00.000Z":4.07534073,"1994-05-01T00:00:00.000Z":4.5406449,"1994-06-01T00:00:00.000Z":4.64561508,"1994-07-01T00:00:00.000Z":4.75260653,"1994-08-01T00:00:00.000Z":5.35060467,"1994-09-01T00:00:00.000Z":5.20445484,"1994-10-01T00:00:00.000Z":5.3016513,"1994-11-01T00:00:00.000Z":5.77374216,"1994-12-01T00:00:00.000Z":6.20459348,"1995-01-01T00:00:00.000Z":6.74948382,"1995-02-01T00:00:00.000Z":4.21606735,"1995-03-01T00:00:00.000Z":4.94934946,"1995-04-01T00:00:00.000Z":4.8230449,"1995-05-01T00:00:00.000Z":5.19475419,"1995-06-01T00:00:00.000Z":5.17078711,"1995-07-01T00:00:00.000Z":5.25674157,"1995-08-01T00:00:00.000Z":5.85527729}'
  v1 = '{"value":{"1991-07-01T00:00:00.000Z":3.526591,"1991-08-01T00:00:00.000Z":3.180891,"1991-09-01T00:00:00.000Z":3.252221,"1991-10-01T00:00:00.000Z":3.611003,"1991-11-01T00:00:00.000Z":3.565869,"1991-12-01T00:00:00.000Z":4.306371,"1992-01-01T00:00:00.000Z":5.088335,"1992-02-01T00:00:00.000Z":2.81452,"1992-03-01T00:00:00.000Z":2.985811,"1992-04-01T00:00:00.000Z":3.20478,"1992-05-01T00:00:00.000Z":3.127578,"1992-06-01T00:00:00.000Z":3.270523,"1992-07-01T00:00:00.000Z":3.73785082,"1992-08-01T00:00:00.000Z":3.55877609,"1992-09-01T00:00:00.000Z":3.77720173,"1992-10-01T00:00:00.000Z":3.92449042,"1992-11-01T00:00:00.000Z":4.38653092,"1992-12-01T00:00:00.000Z":5.81054917,"1993-01-01T00:00:00.000Z":6.19206769,"1993-02-01T00:00:00.000Z":3.45085699,"1993-03-01T00:00:00.000Z":3.77230686,"1993-04-01T00:00:00.000Z":3.7343029,"1993-05-01T00:00:00.000Z":3.90539892,"1993-06-01T00:00:00.000Z":4.04968714,"1993-07-01T00:00:00.000Z":4.31556552,"1993-08-01T00:00:00.000Z":4.56218455,"1993-09-01T00:00:00.000Z":4.60866203,"1993-10-01T00:00:00.000Z":4.66785129,"1993-11-01T00:00:00.000Z":5.09384145,"1993-12-01T00:00:00.000Z":7.1799622,"1994-01-01T00:00:00.000Z":6.73147308,"1994-02-01T00:00:00.000Z":3.84127758,"1994-03-01T00:00:00.000Z":4.39407557,"1994-04-01T00:00:00.000Z":4.07534073,"1994-05-01T00:00:00.000Z":4.5406449,"1994-06-01T00:00:00.000Z":4.64561508,"1994-07-01T00:00:00.000Z":4.75260653,"1994-08-01T00:00:00.000Z":5.35060467,"1994-09-01T00:00:00.000Z":5.20445484,"1994-10-01T00:00:00.000Z":5.3016513,"1994-11-01T00:00:00.000Z":5.77374216,"1994-12-01T00:00:00.000Z":6.20459348,"1995-01-01T00:00:00.000Z":6.74948382,"1995-02-01T00:00:00.000Z":4.21606735,"1995-03-01T00:00:00.000Z":4.94934946,"1995-04-01T00:00:00.000Z":4.8230449,"1995-05-01T00:00:00.000Z":5.19475419,"1995-06-01T00:00:00.000Z":5.17078711,"1995-07-01T00:00:00.000Z":5.25674157,"1995-08-01T00:00:00.000Z":5.85527729}}'
  v2 ='{"v1":{"1991-07-01T00:00:00.000Z":3.526591,"1991-08-01T00:00:00.000Z":3.180891,"1991-09-01T00:00:00.000Z":3.252221,"1991-10-01T00:00:00.000Z":3.611003,"1991-11-01T00:00:00.000Z":3.565869,"1991-12-01T00:00:00.000Z":4.306371,"1992-01-01T00:00:00.000Z":5.088335,"1992-02-01T00:00:00.000Z":2.81452,"1992-03-01T00:00:00.000Z":2.985811,"1992-04-01T00:00:00.000Z":3.20478},"v2":{"1991-07-01T00:00:00.000Z":3.526591,"1991-08-01T00:00:00.000Z":3.180891,"1991-09-01T00:00:00.000Z":3.252221,"1991-10-01T00:00:00.000Z":3.611003,"1991-11-01T00:00:00.000Z":3.565869,"1991-12-01T00:00:00.000Z":4.306371,"1992-01-01T00:00:00.000Z":5.088335,"1992-02-01T00:00:00.000Z":2.81452,"1992-03-01T00:00:00.000Z":2.985811,"1992-04-01T00:00:00.000Z":3.20478}}'
  a0 = json.to.xts(v)
  a1 = json.to.xts(v1)
  a2 = json.to.xts(v2)
  b0 = xts.to.json(a0)
  b1 = xts.to.json(a1)
  b2 = xts.to.json(a2)
  
  csv.data = "\"date\",\"val\"
  \"2010-01-01\",2.77043602187199
  \"2010-01-02\",4.79340521161373
  \"2010-01-03\",6.23034628761291
  \"2010-01-04\",6.97105514089867
  \"2010-01-05\",4.66252127441506
  \"2010-01-06\",4.38619806552318
  \"2010-01-07\",2.3793505372107
  \"2010-01-08\",-0.287823110614097
  \"2010-01-09\",-2.02092932454239
  \"2010-01-10\",-4.05106701997399
  \"2010-01-11\",-3.69269041111052
  \"2010-01-12\",-2.71604390728216"
  d1 = csv.text.to.xts(csv.data)
  e1 = xts.to.csv.text(d1)
}
